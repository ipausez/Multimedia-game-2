<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>space</title>
    <script type="text/javascript" src="simpleGame.js"></script>
    <style>
        /* ✅ ปรับขนาดให้เต็มจอ */
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }
        /* ✅ คอนเทนเนอร์ของเกม */
        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            overflow: hidden;
        }
        /* ✅ ให้ Canvas อยู่บนพื้นหลัง */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #start-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background-color: #008CBA;
            color: white;
            border: none;
            cursor: pointer;
        }
        #start-btn:hover {
            background-color: #005f73;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <button id="start-btn">Start Game</button>
    <script type="text/javascript">
        var ship;
        var game;
        var enemies = [];
        var bullets = [];
        var enemyBullets = []; // เก็บกระสุนของศัตรู
        var frameCount = 0;
        let dragonFrames = [
            "enemy/dragon/frame_1.png",
            "enemy/dragon/frame_2.png",
            "enemy/dragon/frame_3.png",
            "enemy/dragon/frame_4.png"
        ];
        var backgroundMusic;
        var isMusicPlaying = false;

        // โหลดรูปหัวใจสำหรับแสดงสุขภาพ
        var heartImage = new Image();
        heartImage.src = "Heart.png";
        var blackHeartImage = new Image();
        blackHeartImage.src = "blackHeart.png";

        var playerHealth = 3; // ผู้เล่นมีหัวใจ 3 ดวง
        var invincible = false; // สถานะป้องกัน
        let blinkCount = 0; // ตัวแปรสำหรับนับจำนวนการกระพริบ
        let blinkInterval;  // ตัวแปรเก็บการกระพริบเพื่อหยุดมัน

        // เพิ่มตัวแปรสำหรับเก็บ medkit
        var medkits = [];

        // เพิ่มตัวแปรสำหรับ Score
        var score = 0;

        // ตรวจสอบเมื่อมีการคลิกปุ่ม
        document.getElementById('start-btn').addEventListener('click', function () {
            console.log('Start Game button clicked');
            playMusic(); // เริ่มเพลง
            init(); // เริ่มเกม
        });

        function Spaceship() {
            let flyImages = ["player/Fly (1).png", "player/Fly (2).png"];
            let shootImages = [
                "player/Shoot (1).png", "player/Shoot (2).png",
                "player/Shoot (3).png", "player/Shoot (4).png",
                "player/Shoot (5).png"
            ];
            let currentFrame = 0;
            let isShooting = false;

            tShip = new Sprite(game, flyImages[currentFrame], 80, 55);
            tShip.setSpeed(0);
            tShip.setImgAngle(90);
            tShip.setPosition(game.width / 6, game.height / 2);

            tShip.checkKeys = function () {
                if (keysDown[65]) this.setX(this.x - 6);
                if (keysDown[68]) this.setX(this.x + 6);
                if (keysDown[87]) this.setY(this.y - 6);
                if (keysDown[83]) this.setY(this.y + 6);

                // ยิงกระสุน
                if (keysDown[32]) {
                    isShooting = true;
                    if (frameCount % 5 === 0) {
                        shootBullet();
                    }
                } else {
                    isShooting = false;
                }

                this.setX(Math.max(50, Math.min(this.x, game.width - 50)));
                this.setY(Math.max(50, Math.min(this.y, game.height - 50)));
            };

            tShip.animate = function () {
                if (isShooting) {
                    let frameIndex = Math.floor(frameCount / 5) % shootImages.length;
                    this.image.src = (shootImages[frameIndex]);
                } else {
                    if (frameCount % 10 === 0) {
                        currentFrame = (currentFrame + 1) % flyImages.length;
                        this.image.src = (flyImages[currentFrame]);
                    }
                }
            };

            return tShip;
        }

        class Dragon {
            constructor(x, y, speed) {
                this.sprite = new Sprite(game, "enemy/flying_dragon-red.png", 191, 161);
                this.sprite.setSpeed(0);
                this.sprite.setPosition(x, y);
                this.speed = 2;
                this.frameIndex = 0;
                this.framesX = 3;
                this.framesY = 4;
                this.frameWidth = 191;
                this.frameHeight = 161;
                this.totalFrames = this.framesX * this.framesY;
                this.direction = 0;
                this.hitCount = 0;
                this.type = 5;  // มังกรมี type 5
            }

            update() {
                this.move();
                this.animate();
                this.checkCollisionWithPlayer();
            }

            move() {
                let dx = ship.x - this.sprite.x;
                let dy = ship.y - this.sprite.y;
                let angle = Math.atan2(dy, dx);
                this.sprite.setX(this.sprite.x + Math.cos(angle) * this.speed);
                this.sprite.setY(this.sprite.y + Math.sin(angle) * this.speed);
                if (Math.abs(dx) > Math.abs(dy)) {
                    this.direction = dx > 0 ? 1 : 3;
                } else {
                    this.direction = dy < 0 ? 0 : 2;
                }
            }

            animate() {
                if (frameCount % 5 === 0) {
                    this.frameIndex = (this.frameIndex + 1) % this.framesX;
                }
                let frameX = this.frameIndex * this.frameWidth;
                let frameY = this.direction * this.frameHeight;
                game.context.drawImage(
                    this.sprite.image,
                    frameX, frameY,
                    this.frameWidth, this.frameHeight,
                    this.sprite.x - this.frameWidth / 2, this.sprite.y - this.frameHeight / 2,
                    this.frameWidth, this.frameHeight
                );
            }

            // ตรวจจับการชนกับผู้เล่น
            checkCollisionWithPlayer() {
                let distance = distanceBetween(this.sprite, ship);
                if (distance < 50) {
                    playerHealth = 0;
                    invincible = true;
                    setTimeout(() => { invincible = false; }, 1000);
                    console.log('Dragon collided with player!');
                    if (playerHealth <= 0) {
                        playGameOverSound();
                        setTimeout(() => {
                            alert("Game Over!");
                            location.reload();
                        }, 500);
                    }
                }
            }
        }

        class Bullet {
            constructor(x, y) {
                this.sprite = new Sprite(game, "weapon/machine-gun-bullet.png", 15, 30);
                this.sprite.setSpeed(15);
                this.sprite.setPosition(x, y);
                this.sprite.setImgAngle(180);
                this.sprite.setMoveAngle(90);
            }

            update() {
                this.sprite.update();
                if (this.sprite.x > game.width + this.sprite.width) {
                    let index = bullets.indexOf(this);
                    if (index > -1) {
                        bullets.splice(index, 1);
                    }
                }
            }
        }

        // ยิงกระสุนของผู้เล่น พร้อมเล่นเสียง shoot-sound.mp3
        function shootBullet() {
            let bullet = new Bullet(ship.x + 20, ship.y + 15);
            bullets.push(bullet);
            var shootSound = new Audio("sound/shoot-sound.mp3");
            shootSound.currentTime = 0;
            shootSound.play();
        }

        // อัปเดตการเคลื่อนที่ของกระสุนของผู้เล่น
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].update();
                if (bullets[i].sprite.x > game.width - 30) {
                    bullets.splice(i, 1);
                }
            }
        }

        class EnemyBullet {
            constructor(x, y) {
                this.sprite = new Sprite(game, "weapon/Shot5/shot5_asset.png", 120, 80);
                this.sprite.setSpeed(8);
                this.sprite.setPosition(x, y);
                this.sprite.setImgAngle(270);
                this.sprite.setMoveAngle(270);
            }
            update() {
                this.sprite.update();
                if (this.sprite.x > game.width - this.sprite.width) {
                    let index = enemyBullets.indexOf(this);
                    if (index > -1) {
                        enemyBullets.splice(index, 1);
                    }
                }
            }
        }

        function isAlignedVertically(enemy) {
            let enemyTop = enemy.y - enemy.height / 2;
            let enemyBottom = enemy.y + enemy.height / 2;
            let playerTop = ship.y - ship.height / 2;
            let playerBottom = ship.y + ship.height / 2;
            return (
                (playerTop >= enemyTop && playerTop <= enemyBottom) ||
                (playerBottom >= enemyTop && playerBottom <= enemyBottom) ||
                (enemyTop >= playerTop && enemyBottom <= playerBottom)
            );
        }

        function enemyShootBullet(enemy) {
            if (isAlignedVertically(enemy) && frameCount - enemy.lastShotFrame > enemy.shootDelay) {
                let bullet = new EnemyBullet(enemy.x, enemy.y);
                enemyBullets.push(bullet);
                enemy.lastShotFrame = frameCount;
            }
        }

        function updateEnemyBullets() {
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                enemyBullets[i].update();
            }
        }

        function Enemy(x, y, type, speed) {
            let e;
            if (type === 3) {
                e = new Dragon(x, y, speed);
            } else {
                let spriteMap = {
                    1: "enemy/enemy-ship.png",
                    2: "enemy/enemy-spaceship.png"
                };
                e = new Sprite(game, spriteMap[type], 50, 50);
                e.setSpeed(0);
                e.setPosition(x, y);
                e.setImgAngle(0);
                e.type = type;
                e.speed = speed;
                e.shootDelay = Math.floor(Math.random() * 100) + 80;
                e.lastShotFrame = 0;
            }
            e.updateBehavior = function () {
                if (this.type === 1) {
                    this.shrinkAndShake();
                    this.setX(this.x - 2);
                } else if (this.type === 2) {
                    this.shrinkAndShake();
                    enemyShootBullet(this);
                } else if (this.type === 3) {
                    let dx = ship.x - this.x;
                    let dy = ship.y - this.y;
                    let angle = Math.atan2(dy, dx);
                    this.setX(this.x + Math.cos(angle) * 2);
                    this.setY(this.y + Math.sin(angle) * 2);
                }
                if (this.x < -50) {
                    let index = enemies.indexOf(this);
                    if (index > -1) {
                        enemies.splice(index, 1);
                    }
                }
            };
            e.shrinkAndShake = function () {
                let shakeX = Math.random() * 4 - 2;
                let shakeY = Math.random() * 4 - 2;
                this.setX(this.x + shakeX);
                this.setY(this.y + shakeY);
            };
            return e;
        }

        function spawnEnemies(numEnemies) {
            let minY = 50;
            let maxY = game.height - 50;
            let ySpacing = 120;
            let maxRows = 4;
            for (let i = 0; i < numEnemies; i++) {
                let col = Math.floor(i / maxRows);
                let row = i % maxRows;
                let x = Math.random() * (game.width * 0.6) + (game.width * 0.4);
                let y = minY + row * ySpacing + (Math.random() * 50 - 25);
                let enemyType = Math.floor(Math.random() * 3) + 1;
                let enemySpeed = enemyType === 1 ? Math.random() * 4 + 1 : enemyType === 2 ? 0 : Math.random() * 5 + 3;
                let enemy = new Enemy(x, y, enemyType, enemySpeed);
                enemies.push(enemy);
            }
        }

        // ฟังก์ชันแสดงหัวใจที่มุมซ้ายบนของหน้าจอ
        function drawHealth() {
            const heartWidth = 30;
            const heartHeight = 30;
            const spacing = 10;
            for (let i = 0; i < 3; i++) {
                let img = (i < playerHealth) ? heartImage : blackHeartImage;
                game.context.drawImage(img, spacing + i * (heartWidth + spacing), spacing, heartWidth, heartHeight);
            }
        }

        // ฟังก์ชันแสดงคะแนน (Score) ใต้หัวใจ
        function drawScore() {
            game.context.fillStyle = "white";
            game.context.font = "20px Arial";
            // วาด Score ใต้หัวใจ (ตัวอย่าง: y = 50+10 = 60)
            game.context.fillText("Score: " + score, 10, 60);
        }

        function blinkEffect() {
            if (invincible) {
                if (blinkCount === 0) {
                    blinkCount = 5;
                    blinkInterval = setInterval(() => {
                        ship.image.src = (ship.image.src.includes("Fly (1)"))
                            ? "player/Fly (2).png"
                            : "player/Fly (1).png";
                        blinkCount--;
                        if (blinkCount <= 0) {
                            clearInterval(blinkInterval);
                            ship.image.src = "player/Fly (1).png";
                        }
                    }, 200);
                }
            } else {
                if (blinkInterval) {
                    clearInterval(blinkInterval);
                }
                ship.image.src = "player/Fly (1).png";
            }
        }

        // ฟังก์ชันคำนวณระยะห่างระหว่างสองจุด
        function distanceBetween(sprite1, sprite2) {
            let dx = sprite1.x - sprite2.x;
            let dy = sprite1.y - sprite2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function playDeathSound() {
            var sound = new Audio("sound/injured-sound.mp3");
            sound.currentTime = 0;
            sound.play();
        }

        function playGameOverSound() {
            var gameOverSound = new Audio("sound/gameOver-sound.mp3");
            gameOverSound.currentTime = 0;
            gameOverSound.play();
        }

        // ฟังก์ชันตรวจจับการชนและสร้าง damage
        function checkCollisions() {
            if (invincible) return;
            for (let enemy of enemies) {
                let distance = distanceBetween(ship, enemy);
                if (distance < 50) {
                    console.log('Collision detected!');
                    playerHealth--;
                    playDeathSound();
                    invincible = true;
                    setTimeout(() => { invincible = false; }, 1000);
                    let index = enemies.indexOf(enemy);
                    if (index > -1) {
                        enemies.splice(index, 1);
                    }
                    let blinkCount = 5;
                    let blinkInterval = setInterval(() => {
                        ship.image.src = (ship.image.src.includes("Fly (1)"))
                            ? "player/Fly (2).png"
                            : "player/Fly (1).png";
                        blinkCount--;
                        if (blinkCount <= 0) clearInterval(blinkInterval);
                    }, 200);
                    if (playerHealth <= 0) {
                        playGameOverSound();
                        setTimeout(() => {
                            alert("Game Over!");
                            location.reload();
                        }, 500);
                    }
                    break;
                }
            }
        }

        // ฟังก์ชันตรวจจับการชนระหว่างกระสุนของผู้เล่นกับศัตรู
        function checkBulletEnemyCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                let bullet = bullets[i];
                for (let j = enemies.length - 1; j >= 0; j--) {
                    let enemy = enemies[j];
                    let enemySprite = enemy.sprite ? enemy.sprite : enemy;
                    let distance = distanceBetween(bullet.sprite, enemySprite);
                    if (distance <= 30) {
                        if (enemy.type === 5) {
                            enemy.hitCount++;
                            bullets.splice(i, 1);
                            if (enemy.hitCount < 5) {
                                break;
                            } else {
                                // เมื่อโดนครบ 5 นัด ให้เพิ่มคะแนน 3 แต้ม และลบมังกรออก
                                score += 5;
                                enemies.splice(j, 1);
                                if (medkits.length === 0) {
                                    onEnemyDestroyed();
                                }
                                setTimeout(() => {
                                    let enemyType = 3; // มังกร
                                    let newPos = getRandomPosition();
                                    let newEnemy = new Enemy(newPos.x, newPos.y, enemyType, Math.random() * 5 + 3);
                                    enemies.push(newEnemy);
                                }, 5000);
                            }
                        } else {
                            // สำหรับศัตรูประเภทอื่น เพิ่มคะแนน 1 แต้ม
                            score += 1;
                            enemies.splice(j, 1);
                            bullets.splice(i, 1);
                            if (medkits.length === 0) {
                                onEnemyDestroyed();
                            }
                            setTimeout(() => {
                                let enemyType = Math.floor(Math.random() * 3) + 1;
                                let newPos = getRandomPosition();
                                let newEnemy = new Enemy(newPos.x, newPos.y, enemyType, Math.random() * 5 + 3);
                                enemies.push(newEnemy);
                            }, 5000);
                        }
                        break;
                    }
                }
            }
        }

        // ฟังก์ชันตรวจจับการชนระหว่างกระสุนศัตรูกับผู้เล่น
        function checkEnemyBulletCollisions() {
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                let bullet = enemyBullets[i];
                let distance = distanceBetween(bullet.sprite, ship);
                if (distance < 50) {
                    playerHealth--;
                    playDeathSound();
                    invincible = true;
                    setTimeout(() => { invincible = false; }, 1000);
                    console.log('Player hit by enemy bullet!');
                    enemyBullets.splice(i, 1);
                    if (playerHealth <= 0) {
                        playGameOverSound();
                        setTimeout(() => {
                            alert("Game Over!");
                            location.reload();
                        }, 500);
                    }
                }
            }
        }

        function getRandomPosition() {
            let spawnX = Math.random() * (game.width / 2) + game.width / 2;
            let spawnY = Math.random() * game.height;
            spawnX = Math.max(50, Math.min(spawnX, game.width - 50));
            spawnY = Math.max(50, Math.min(spawnY, game.height - 50));
            while (Math.abs(spawnX - ship.x) < 200 || Math.abs(spawnY - ship.y) < 200) {
                spawnX = Math.random() * (game.width / 2) + game.width / 2;
                spawnY = Math.random() * game.height;
            }
            return { x: spawnX, y: spawnY };
        }

        function spawnMedkit() {
            let spawnX = Math.random() * (game.width / 2) + game.width / 2;
            let spawnY = Math.random() * game.height;
            while (Math.abs(spawnX - ship.x) < 200 || Math.abs(spawnY - ship.y) < 200) {
                spawnX = Math.random() * (game.width / 2) + game.width / 2;
                spawnY = Math.random() * game.height;
            }
            let newMedkit = new Sprite(game, "medkit.png", 50, 50);
            newMedkit.setSpeed(0);
            newMedkit.setPosition(spawnX, spawnY);
            medkits.push(newMedkit);
        }

        function checkMedkitCollision() {
            for (let i = 0; i < medkits.length; i++) {
                let medkit = medkits[i];
                let distance = distanceBetween(medkit, ship);
                if (distance < 50) {
                    if (playerHealth < 3) {
                        playerHealth++;
                        medkits.splice(i, 1);
                        console.log("Medkit collected, health increased");
                    } else {
                        console.log("Health is full, medkit cannot be collected");
                    }
                    break;
                }
            }
        }

        function onEnemyDestroyed() {
            if (enemies.length % 10 === 0) {
                spawnMedkit();
            }
        }

        function playMusic() {
            console.log('Playing music...');
            if (!isMusicPlaying) {
                backgroundMusic = new Sound('other-assets/sounds/jetpack-joyride-theme.mp3');
                backgroundMusic.snd.volume = 0.1;
                backgroundMusic.snd.loop = true;
                backgroundMusic.play();
                isMusicPlaying = true;
                document.getElementById('start-btn').style.display = 'none';
            }
        }

        function init() {
            console.log('Game initialization...');
            game = new Scene();
            game.setSize(1280, 720);
            game.backgroundVideo = document.createElement("video");
            game.backgroundVideo.src = "background-video.mp4";
            game.backgroundVideo.autoplay = true;
            game.backgroundVideo.loop = true;
            game.backgroundVideo.muted = true;
            game.backgroundVideo.play();
            document.getElementById("game-container").appendChild(game.canvas);
            ship = new Spaceship();
            spawnEnemies(20);
            game.start();
        }

        function update() {
            game.clear();
            game.context.drawImage(game.backgroundVideo, 0, 0, game.width, game.height);
            checkBulletEnemyCollisions();
            checkEnemyBulletCollisions();
            checkCollisions();
            checkMedkitCollision();
            ship.checkKeys();
            ship.animate();
            ship.update();
            updateBullets();
            updateEnemyBullets();
            for (let enemy of enemies) {
                enemy.updateBehavior();
                enemy.update();
            }
            for (let medkit of medkits) {
                medkit.update();
                game.context.drawImage(medkit.image, medkit.x - medkit.width / 2, medkit.y - medkit.height / 2, medkit.width, medkit.height);
            }
            drawHealth();
            drawScore(); // วาดคะแนน
            // blinkEffect();
            frameCount++;
        }
    </script>
</body>
</html>
